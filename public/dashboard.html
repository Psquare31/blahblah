<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Agentic Recipe App</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">
                <i class="fas fa-robot"></i>
                Agentic Recipe Assistant
            </h1>
            <div class="user-menu">
                <a href="/" class="btn btn-secondary">Home</a>
                <span id="userName">User</span>
                <a href="/auth/logout" class="btn btn-secondary">Logout</a>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <section class="dashboard-section">
                <h2>Welcome to Your Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3><i class="fas fa-utensils"></i> Generate New Recipe</h3>
                        <p>Create personalized recipes based on your ingredients and preferences.</p>
                        <a href="/" class="btn btn-primary">Create Recipe</a>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Recipe History</h3>
                        <p>View your previously generated recipes.</p>
                        <button id="viewHistory" class="btn btn-secondary">View History</button>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-comments"></i> Chat History</h3>
                        <p>Review your previous conversations with our AI agents.</p>
                        <button id="viewChatHistory" class="btn btn-secondary">View Chat History</button>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-user"></i> Profile Settings</h3>
                        <p>Manage your account and preferences.</p>
                        <button id="viewProfile" class="btn btn-secondary">View Profile</button>
                    </div>
                </div>
            </section>
            
            <section class="profile-section" id="profileSection" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-user"></i> Your Profile</h3>
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="displayName">Display Name</label>
                            <input type="text" id="displayName" name="displayName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Statistics</label>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-value" id="recipeCount">0</span>
                                    <span class="stat-label">Recipes Generated</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="chatCount">0</span>
                                    <span class="stat-label">Chats</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                            <button type="button" id="deleteAccount" class="btn btn-danger">Delete Account</button>
                        </div>
                    </form>
                </div>
            </section>
            
            <section class="history-section" id="historySection" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-history"></i> Your Recipe History</h3>
                    <div id="recipeHistoryList"></div>
                </div>
            </section>
            
            <section class="chat-history-section" id="chatHistorySection" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-comments"></i> Your Chat History</h3>
                    <div id="chatHistoryList"></div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Agentic Recipe Assistant | Powered by GenAI & Multi-Agent Architecture</p>
        </div>
    </footer>

    <script>
        // Dashboard functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Load user profile
            loadUserProfile();
            
            // Event listeners
            document.getElementById('viewProfile').addEventListener('click', () => {
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('historySection').style.display = 'none';
                document.getElementById('chatHistorySection').style.display = 'none';
            });
            
            document.getElementById('viewHistory').addEventListener('click', () => {
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('historySection').style.display = 'block';
                document.getElementById('chatHistorySection').style.display = 'none';
                loadRecipeHistory();
            });
            
            document.getElementById('viewChatHistory').addEventListener('click', () => {
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('historySection').style.display = 'none';
                document.getElementById('chatHistorySection').style.display = 'block';
                loadChatHistory();
            });
            
            // Profile form submission
            document.getElementById('profileForm').addEventListener('submit', updateProfile);
            
            // Delete account
            document.getElementById('deleteAccount').addEventListener('click', deleteAccount);
            
            // Add click event to userName in header to redirect to dashboard
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.addEventListener('click', () => {
                    // Already on dashboard, so no redirect needed
                    // But we can add some visual feedback
                    userNameElement.style.fontWeight = 'bold';
                    setTimeout(() => {
                        userNameElement.style.fontWeight = 'normal';
                    }, 500);
                });
                userNameElement.style.cursor = 'pointer';
            }
        });
        
        async function loadUserProfile() {
            try {
                // Fetch actual user data from the server
                const response = await fetch('/api/profile');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.user) {
                        const user = result.user;
                        
                        // Update user name in header
                        document.getElementById('userName').textContent = user.displayName || 'User';
                        
                        // Update profile form fields
                        document.getElementById('displayName').value = user.displayName || '';
                        document.getElementById('firstName').value = user.firstName || '';
                        document.getElementById('lastName').value = user.lastName || '';
                        
                        // Update statistics
                        document.getElementById('recipeCount').textContent = user.recipeCount || 0;
                        document.getElementById('chatCount').textContent = user.chatCount || 0;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        async function updateProfile(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const profileData = {
                    displayName: formData.get('displayName'),
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName')
                };
                
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Update the user data
                        if (result.user) {
                            document.getElementById('userName').textContent = result.user.displayName || 'User';
                        }
                        
                        alert('Profile updated successfully!');
                        
                        // Redirect to homepage
                        window.location.href = '/';
                    } else {
                        alert('Failed to update profile: ' + (result.message || 'Unknown error'));
                    }
                } else {
                    const errorResult = await response.json();
                    alert('Failed to update profile: ' + (errorResult.message || 'Server error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile: ' + error.message);
            }
        }
        
        async function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/profile', {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Account deleted successfully!');
                        window.location.href = '/auth/logout';
                    } else {
                        const errorResult = await response.json();
                        alert('Failed to delete account: ' + (errorResult.message || 'Server error'));
                    }
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account: ' + error.message);
                }
            }
        }
        
        async function loadRecipeHistory() {
            try {
                const response = await fetch('/api/recipes/history');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.recipes) {
                        displayRecipeHistory(result.recipes);
                    } else {
                        document.getElementById('recipeHistoryList').innerHTML = `
                            <p>You haven't generated any recipes yet. <a href="/">Create your first recipe!</a></p>
                        `;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Recipe history API error:', response.status, errorText);
                    document.getElementById('recipeHistoryList').innerHTML = `
                        <p>Error loading recipe history: ${response.status} - ${response.statusText}</p>
                        <p>Please try again later or contact support.</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading recipe history:', error);
                document.getElementById('recipeHistoryList').innerHTML = `
                    <p>Error loading recipe history: ${error.message}</p>
                    <p>Please check your network connection and try again.</p>
                `;
            }
        }
        
        function displayRecipeHistory(recipes) {
            if (recipes.length === 0) {
                document.getElementById('recipeHistoryList').innerHTML = `
                    <p>You haven't generated any recipes yet. <a href="/">Create your first recipe!</a></p>
                `;
                return;
            }
            
            let html = '<div class="recipe-history-grid">';
            recipes.forEach(recipe => {
                html += `
                    <div class="recipe-history-item card">
                        <h4>${recipe.name || 'Unnamed Recipe'}</h4>
                        <p class="recipe-date">Generated on: ${new Date(recipe.createdAt).toLocaleDateString()}</p>
                        <button class="btn btn-primary view-recipe" data-recipe-id="${recipe._id}">View Recipe</button>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('recipeHistoryList').innerHTML = html;
            
            // Add event listeners to view recipe buttons
            document.querySelectorAll('.view-recipe').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const recipeId = e.target.dataset.recipeId;
                    await viewRecipe(recipeId);
                });
            });
        }

        async function viewRecipe(recipeId) {
            try {
                // Show loading indicator
                const recipeHistoryList = document.getElementById('recipeHistoryList');
                const originalContent = recipeHistoryList.innerHTML;
                recipeHistoryList.innerHTML = '<p>Loading recipe details...</p>';
                
                // Fetch the full recipe details
                const response = await fetch(`/api/recipes/${recipeId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.recipe) {
                        // Restore original content and display the recipe in a modal
                        recipeHistoryList.innerHTML = originalContent;
                        displayFullRecipe(result.recipe);
                    } else {
                        recipeHistoryList.innerHTML = originalContent;
                        alert('Failed to load recipe details: ' + (result.message || 'Unknown error'));
                    }
                } else {
                    recipeHistoryList.innerHTML = originalContent;
                    const errorText = await response.text();
                    alert('Failed to load recipe details: ' + response.status + ' - ' + response.statusText + '\n' + errorText);
                }
            } catch (error) {
                console.error('Error viewing recipe:', error);
                document.getElementById('recipeHistoryList').innerHTML = `
                    <p>Error loading recipe details: ${error.message}</p>
                    <p>Please check your network connection and try again.</p>
                `;
            }
        }

        function displayFullRecipe(recipe) {
            // Create a modal or overlay to display the full recipe
            const modal = document.createElement('div');
            modal.className = 'recipe-modal';
            modal.innerHTML = `
                <div class="recipe-modal-content card">
                    <span class="close-modal">&times;</span>
                    <h2>${recipe.name || 'Recipe'}</h2>
                    ${formatStructuredRecipe(recipe)}
                    <button class="btn btn-secondary close-modal-btn">Close</button>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(modal);
            
            // Add event listeners to close the modal
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.close-modal-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Close on escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/api/recipes/chat-history');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.chats) {
                        displayChatHistory(result.chats);
                    } else {
                        document.getElementById('chatHistoryList').innerHTML = `
                            <p>No chat history yet.</p>
                        `;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Chat history API error:', response.status, errorText);
                    document.getElementById('chatHistoryList').innerHTML = `
                        <p>Error loading chat history: ${response.status} - ${response.statusText}</p>
                        <p>Please try again later or contact support.</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                document.getElementById('chatHistoryList').innerHTML = `
                    <p>Error loading chat history: ${error.message}</p>
                    <p>Please check your network connection and try again.</p>
                `;
            }
        }
        
        function displayChatHistory(chats) {
            if (chats.length === 0) {
                document.getElementById('chatHistoryList').innerHTML = `
                    <p>No chat history yet.</p>
                `;
                return;
            }
            
            let html = '<div class="chat-history-list">';
            chats.forEach((chat, index) => {
                html += `
                    <div class="chat-history-item card">
                        <div class="chat-header" onclick="toggleChatDetails(${index})">
                            <h4><i class="fas fa-comment"></i> Chat #${index + 1}</h4>
                            <p class="chat-message-preview"><strong>You:</strong> ${chat.message.substring(0, 50)}${chat.message.length > 50 ? '...' : ''}</p>
                            <p class="chat-date">${new Date(chat.timestamp).toLocaleString()}</p>
                            <span class="toggle-icon" id="toggle-icon-${index}">▼</span>
                        </div>
                        <div class="chat-details" id="chat-details-${index}" style="display: none;">
                            <p class="chat-message"><strong>You:</strong> ${chat.message}</p>
                            <p class="chat-response"><strong>Assistant:</strong></p>
                            <div class="chat-response-content">${formatChatResponse(chat.response)}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('chatHistoryList').innerHTML = html;
        }

        function toggleChatDetails(index) {
            const details = document.getElementById(`chat-details-${index}`);
            const icon = document.getElementById(`toggle-icon-${index}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '▲';
            } else {
                details.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        function formatChatResponse(response) {
            // Try to parse as JSON first
            try {
                const jsonData = JSON.parse(response);
                // If it's a JSON object, format it properly
                return formatStructuredChatResponse(jsonData);
            } catch (e) {
                // Not JSON, format as text
                return formatRecipeText(response);
            }
        }

        function formatStructuredChatResponse(responseData) {
            if (typeof responseData === 'string') {
                return formatRecipeText(responseData);
            }
            
            if (typeof responseData === 'object') {
                // Check if it's a recipe response
                if (responseData.recipe) {
                    return formatStructuredRecipe(responseData.recipe);
                }
                
                // Check if it's a meal plan response
                if (responseData.mealPlan) {
                    return formatStructuredMealPlan(responseData.mealPlan);
                }
                
                // Check if it's a grocery list response
                if (responseData.groceryList) {
                    return formatStructuredGroceryList(responseData.groceryList);
                }
                
                // Generic formatting for other JSON objects
                let html = '<div class="structured-response">';
                Object.keys(responseData).forEach(key => {
                    html += `<h5>${key.charAt(0).toUpperCase() + key.slice(1)}:</h5>`;
                    if (typeof responseData[key] === 'string') {
                        html += `<p>${responseData[key]}</p>`;
                    } else {
                        html += `<p>${JSON.stringify(responseData[key], null, 2)}</p>`;
                    }
                });
                html += '</div>';
                return html;
            }
            
            return formatRecipeText(JSON.stringify(responseData, null, 2));
        }

        // Formatting Functions (copied from app.js)
        function formatRecipeText(text) {
            // Basic text formatting for recipe content
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            return `<p>${formatted}</p>`;
        }

        function formatStructuredRecipe(recipe) {
            let html = `<div class="recipe-content">`;
            
            if (recipe.name) {
                html += `<h4>${recipe.name}</h4>`;
            }
            
            if (recipe.description) {
                html += `<p>${recipe.description}</p>`;
            }
            
            if (recipe.ingredients && recipe.ingredients.length > 0) {
                html += `<div class="ingredient-list">
                    <h5><i class="fas fa-list"></i> Ingredients:</h5>
                    <ul>`;
                recipe.ingredients.forEach(ingredient => {
                    html += `<li>${ingredient}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (recipe.instructions && recipe.instructions.length > 0) {
                html += `<h5><i class="fas fa-clipboard-list"></i> Instructions:</h5>`;
                recipe.instructions.forEach((instruction, index) => {
                    html += `<div class="instruction-step">
                        <strong>Step ${index + 1}:</strong> ${instruction}
                    </div>`;
                });
            }
            
            if (recipe.metadata) {
                html += `<div class="nutrition-info">
                    ${recipe.metadata.prepTime ? `<div class="nutrition-item"><strong>Prep Time</strong><span>${recipe.metadata.prepTime}</span></div>` : ''}
                    ${recipe.metadata.cookTime ? `<div class="nutrition-item"><strong>Cook Time</strong><span>${recipe.metadata.cookTime}</span></div>` : ''}
                    ${recipe.metadata.servings ? `<div class="nutrition-item"><strong>Servings</strong><span>${recipe.metadata.servings}</span></div>` : ''}
                </div>`;
            }
            
            html += `</div>`;
            return html;
        }

        function formatStructuredMealPlan(mealPlan) {
            if (typeof mealPlan === 'string') {
                try {
                    mealPlan = JSON.parse(mealPlan);
                } catch (e) {
                    return formatRecipeText(mealPlan);
                }
            }
            
            let html = '<div class="meal-plan-content">';
            
            // Handle different meal plan structures
            if (mealPlan.days) {
                // Format by days
                mealPlan.days.forEach((day, index) => {
                    html += `<div class="meal-section">`;
                    html += `<h4>Day ${index + 1}${day.name ? `: ${day.name}` : ''}</h4>`;
                    
                    if (day.meals) {
                        Object.keys(day.meals).forEach(mealType => {
                            html += `<h5><strong>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}:</strong></h5>`;
                            html += `<p>${day.meals[mealType]}</p>`;
                        });
                    }
                    html += `</div>`;
                });
            } else if (mealPlan.mealPlan) {
                // Format meal plan object
                const plan = mealPlan.mealPlan;
                Object.keys(plan).forEach(day => {
                    html += `<div class="meal-section">`;
                    html += `<h4>${day}</h4>`;
                    
                    const meals = plan[day];
                    Object.keys(meals).forEach(mealType => {
                        html += `<h5><strong>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}:</strong></h5>`;
                        if (typeof meals[mealType] === 'string') {
                            html += `<p>${meals[mealType]}</p>`;
                        } else if (typeof meals[mealType] === 'object') {
                            html += `<p>${JSON.stringify(meals[mealType], null, 2)}</p>`;
                        }
                    });
                    html += `</div>`;
                });
            } else {
                // Generic formatting for unknown structure
                html += formatRecipeText(JSON.stringify(mealPlan, null, 2));
            }
            
            html += '</div>';
            return html;
        }

        function formatStructuredGroceryList(groceryList) {
            if (typeof groceryList === 'string') {
                try {
                    groceryList = JSON.parse(groceryList);
                } catch (e) {
                    return formatRecipeText(groceryList);
                }
            }
            
            let html = '<div class="grocery-content">';
            html += '<h4><i class="fas fa-shopping-cart"></i> Shopping List</h4>';
            
            // Handle different grocery list structures
            if (Array.isArray(groceryList)) {
                // Format as array of items
                html += '<ul class="grocery-list">';
                groceryList.forEach(item => {
                    if (typeof item === 'string') {
                        html += `<li>${item}</li>`;
                    } else if (typeof item === 'object') {
                        html += '<li>';
                        if (item.name) html += `<strong>${item.name}</strong>`;
                        if (item.quantity) html += ` - Quantity: ${item.quantity}`;
                        if (item.price) html += ` - Price: ${item.price}`;
                        if (item.store) html += ` - Store: ${item.store}`;
                        html += '</li>';
                    }
                });
                html += '</ul>';
            } else if (groceryList.items) {
                // Format as object with items property
                html += '<ul class="grocery-list">';
                groceryList.items.forEach(item => {
                    html += '<li>';
                    if (item.name) html += `<strong>${item.name}</strong>`;
                    if (item.quantity) html += ` - Quantity: ${item.quantity}`;
                    if (item.price) html += ` - Price: ${item.price}`;
                    if (item.store) html += ` - Store: ${item.store}`;
                    html += '</li>';
                });
                html += '</ul>';
            } else if (groceryList.list) {
                // Format as object with list property
                html += '<ul class="grocery-list">';
                groceryList.list.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul>';
            } else {
                // Generic formatting for unknown structure
                html += formatRecipeText(JSON.stringify(groceryList, null, 2));
            }
            
            html += '</div>';
            return html;
        }

    </script>
</body>
</html>